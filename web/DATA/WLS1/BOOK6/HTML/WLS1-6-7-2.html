<div id="module_wrapper" class="WS_workbook_wrapper WLS1-6-7-2">
  <div class="mascot wow fadeInDown">
    <img
      class="wow rubberBand"
      data-wow-iteration="infinite"
      src="./images/common/giraffe_read.png"
    />
    <span>Open your book, please.</span>
  </div>
  <div class="tabs">
    <span>part 1</span>
    <span>part 2</span>
    <span>part 3</span>
    <span>part 4</span>
  </div>
  <div id="contents" class="contents">
    <div>
      <span class="ans">
        <span class="ring" style="top: 57px; left: 57px" />
        <span class="ring" style="top: 53px; left: 287px" />
        <span class="ring" style="top: 135px; left: 130px" />
        <span class="ring" style="top: 135px; left: 289px" />
      </span>
      <span class="selection">
        <span class="ring nomove s1" style="top: 57px; left: 57px" />
        <span class="ring nomove s1" style="top: 57px; left: 132px" />
        <span class="ring nomove s2" style="top: 53px; left: 222px" />
        <span class="ring nomove s2" style="top: 53px; left: 287px" />
        <span class="ring nomove s3" style="top: 135px; left: 57px" />
        <span class="ring nomove s3" style="top: 135px; left: 130px" />
        <span class="ring nomove s4" style="top: 135px; left: 224px" />
        <span class="ring nomove s4" style="top: 135px; left: 289px" />
      </span>
      <span> <img src="./DATA/WLS1/BOOK6/IMAGES/WLS1-6-7-2-1.jpg" /></span>
      <audio
        class="a1"
        preload="auto"
        src="./DATA/WLS1/BOOK6/AUDIO/WLS1-6-7-2-1.mp3"
      />
    </div>
    <div>
      <span class="sensor demo" style="top: 50px; left: 0px; height: 70px">
        <img
          style="top: -50px"
          src="./DATA/WLS1/BOOK6/IMAGES/WLS1-6-7-2-2A.jpg"
        />
        <audio
          preload="auto"
          st="0"
          et="7.4"
          src="./DATA/WLS1/BOOK6/AUDIO/WLS1-6-7-2-2.mp3"
        />
      </span>
      <span class="sensor" style="top: 122px; left: 0px; height: 70px">
        <img
          style="top: -122px"
          src="./DATA/WLS1/BOOK6/IMAGES/WLS1-6-7-2-2A.jpg"
        />
        <audio
          preload="auto"
          st="7.4"
          et="14.2"
          src="./DATA/WLS1/BOOK6/AUDIO/WLS1-6-7-2-2.mp3"
        />
      </span>
      <span class="sensor" style="top: 200px; left: 0px; height: 70px">
        <img
          style="top: -200px"
          src="./DATA/WLS1/BOOK6/IMAGES/WLS1-6-7-2-2A.jpg"
        />
        <audio
          preload="auto"
          st="14.2"
          et="22"
          src="./DATA/WLS1/BOOK6/AUDIO/WLS1-6-7-2-2.mp3"
        />
      </span>
      <span class="sensor" style="top: 276px; left: 0px; height: 70px">
        <img
          style="top: -276px"
          src="./DATA/WLS1/BOOK6/IMAGES/WLS1-6-7-2-2A.jpg"
        />
        <audio
          preload="auto"
          st="22"
          et="30.2"
          src="./DATA/WLS1/BOOK6/AUDIO/WLS1-6-7-2-2.mp3"
        />
      </span>
      <span class="sensor" style="top: 350px; left: 0px; height: 70px">
        <img
          style="top: -350px"
          src="./DATA/WLS1/BOOK6/IMAGES/WLS1-6-7-2-2A.jpg"
        />
        <audio
          preload="auto"
          st="30.2"
          et="45.5"
          src="./DATA/WLS1/BOOK6/AUDIO/WLS1-6-7-2-2.mp3"
        />
      </span>
      <span> <img src="./DATA/WLS1/BOOK6/IMAGES/WLS1-6-7-2-2.jpg" /></span>
    </div>
    <div>
      <span> <img src="./DATA/WLS1/BOOK6/IMAGES/WLS1-6-7-2-3.jpg" /></span>
      <span class="ans">
        <img src="./DATA/WLS1/BOOK6/IMAGES/WLS1-6-7-2-3A.jpg"
      /></span>
      <audio
        class="a1"
        preload="auto"
        src="./DATA/WLS1/BOOK6/AUDIO/WLS1-6-7-2-3.mp3"
      />
    </div>
    <div>
      <span> <img src="./DATA/WLS1/BOOK6/IMAGES/WLS1-6-7-2-4.jpg" /></span>
      <span class="ans">
        <img src="./DATA/WLS1/BOOK6/IMAGES/WLS1-6-7-2-4A.jpg"
      /></span>
      <audio
        class="a1"
        preload="auto"
        src="./DATA/WLS1/BOOK6/AUDIO/WLS1-6-7-2-4.mp3"
      />
    </div>
  </div>
  <div class="sideTool">
    <div class="eye"></div>
    <div class="fit"></div>
    <div class="speaker a1"></div>
    <div class="speaker a2">2</div>
  </div>
  <div class="assetsPreload">
    <img src="./images/common/btn_eye.png" />
    <img src="./images/common/btn_speaker.png" />
    <img src="./images/common/btn_fit.png" />
    <img src="./images/common/giraffe_read.png" />
  </div>
</div>
<script>
  $(document).ready(function () {
    //載入完成要執行init
    $("#module_wrapper")
      .unbind()
      .bind("compLoaded", function () {
        //
        $("#module_wrapper .fillbox")
          .find(">span")
          .unbind()
          .bind("click", function () {
            $(this).toggleClass("active");
          });
        //
        $("#module_wrapper .selection")
          .find(".ring")
          .each(function () {
            $(this)
              .unbind()
              .bind("click", function () {
                //do someing
                var classset = $(this).attr("class");
                classset = classset.replace("ring", "");
                classset = classset.replace("nomove", "");
                classset = classset.replace("active", "");
                classset = classset.replace("  ", "");
                classset = classset.replace(" ", "");
                $("#module_wrapper .selection")
                  .find("." + classset + ".active")
                  .removeClass("active");
                $(this).addClass("active");
              });
          });
        //lowlag audios
        var tempSound = $(this).find("audio");
        if (tempSound.length > 0) {
          tempSound.each(function () {
            if ($SFXNameAr.indexOf($(this).attr("src")) == -1) {
              $SFXNameAr.push($(this).attr("src"));
              $SFXAr.push(new Audio($(this).attr("src")));
            }
          });
        }
        //sensor
        $(".sensor")
          .unbind()
          .bind("mousedown", function (ev) {
            click.x = ev.clientX;
            click.y = ev.clientY;
          })
          .bind("mouseup", function (ev) {
            if (click.x == ev.clientX && click.y == ev.clientY) {
              $(this).toggleClass("active");
              if ($(this).hasClass("active")) {
                rootSoundEffectName(
                  $(this).find("audio").attr("src"),
                  false,
                  parseInt($(this).find("audio").attr("st")),
                  parseInt($(this).find("audio").attr("et"))
                );
              } else {
                resetAudio();
              }
            }
          });

        //hammer
        trigHammer();

        //tabs
        $(".tabs > span")
          .unbind()
          .bind("click", function () {
            if (!$(this).hasClass("selected")) {
              if (!lowlaged) {
                lowlaged = true;
                lowlagSFX();
                activeSFX();
              }
              //init
              $(this)
                .addClass("selected")
                .siblings(".selected")
                .removeClass("selected");
              openContent($(this).index());
            }
          });
        if ($(".tabs > span").length < 2) {
          $(".tabs").hide();
        }
        //
        $(".WLS1-1-8-1 .ans1,.WLS1-1-8-1 .ans2").hide();
        $(".WLS1-1-8-1 .eye1")
          .unbind()
          .bind("click", function () {
            $(this).toggleClass("active");
            if ($(this).hasClass("active")) {
              $(".WLS1-1-8-1 .ans1").fadeIn();
            } else {
              $(".WLS1-1-8-1 .ans1").hide();
            }
          });
        $(".WLS1-1-8-1 .eye2")
          .unbind()
          .bind("click", function () {
            $(this).toggleClass("active");
            if ($(this).hasClass("active")) {
              $(".WLS1-1-8-1 .ans2").fadeIn();
            } else {
              $(".WLS1-1-8-1 .ans2").hide();
            }
          });

        //sidetool
        $(".sideTool > div.speaker.a1")
          .unbind()
          .bind("click", function () {
            $(this)
              .toggleClass("active")
              .siblings(".speaker.active")
              .removeClass("active");
            if ($(this).hasClass("active")) {
              rootSoundEffectName(
                $(".contents > div.selected").find("audio.a1").attr("src"),
                true
              );
            } else {
              closePlayer();
            }
          });
        $(".sideTool > div.speaker.a2")
          .unbind()
          .bind("click", function () {
            $(this)
              .toggleClass("active")
              .siblings(".speaker.active")
              .removeClass("active");
            if ($(this).hasClass("active")) {
              rootSoundEffectName(
                $(".contents > div.selected").find("audio.a2").attr("src"),
                true
              );
            } else {
              closePlayer();
            }
          });

        $(".sideTool > div.eye")
          .unbind()
          .bind("click", function () {
            $(this).toggleClass("active");
            $(".contents > div.selected").toggleClass("showANS");
          });
        $(".sideTool > div.fit")
          .unbind()
          .bind("click", function () {
            $(this).toggleClass("active");
            if ($(this).hasClass("active")) {
              //fit height
              var currentH = $(".contents > div.selected").height();
              var fitH = $("#root").height() * 0.9 - 50;
              var scaleTo = fitH / currentH;
              insideRatio = scaleTo;
              var ft = ($("#root").height() - currentH) / 2 / stageRatio - 25;
              var styles = {
                transform: "scale(" + scaleTo + ")",
                top: ft,
                left: 200,
              };
              $(".contents > div.selected").css(styles);
            } else {
              insideRatio = 1;
              //origin

              var styles = {
                transform: "none",
              };
              $(".contents > div.selected").css(styles);
            }
          });

        //init

        $(this)
          .addClass("loaded")
          .delay(500)
          .queue(function () {
            $(".tabs > span").eq(0).click();
            $(this).dequeue().unbind();
          });
        deactiveLoading();
      });

    $("#module_wrapper #contents")
      .find("img")
      .each(function (i) {
        $(this).clone().appendTo("#module_wrapper .assetsPreload");
      });
    //check loading
    checkCompLoading("#module_wrapper");
  });

  var lowlaged = false;
  var lastPosX = 0;
  var lastPosY = 0;
  var isDragging = false;
  var $elem = new Object();
  var insideRatio = 1;

  var trigHammer = function () {
    //hammer
    var myElement = document.getElementById("contents");
    var mc = new Hammer(myElement);
    mc.get("pan").set({ direction: Hammer.DIRECTION_ALL });
    mc.on("pan", function (ev) {
      handleDrag(ev);
    });
  };

  var handleDrag = function (ev) {
    var elem = ev.target;
    if ($(elem).hasClass("sensor")) {
      elem = $(elem).parent().get(0);
    }

    if (!isDragging && !$(elem).hasClass("nomove")) {
      isDragging = true;
      $elem = elem;
      if ($(elem).hasClass("sensor")) {
        $elem = $(elem).parent().get(0);
      }
      lastPosX = elem.offsetLeft;
      lastPosY = elem.offsetTop;
    }

    if (elem == $elem && !$(elem).hasClass("nomove")) {
      var posX = ev.deltaX / stageRatio + lastPosX;
      var posY = ev.deltaY / stageRatio + lastPosY;
      if ($(elem).hasClass("piece1") || $(elem).hasClass("piece2")) {
        posX = ev.deltaX / stageRatio / insideRatio + lastPosX;
        posY = ev.deltaY / stageRatio / insideRatio + lastPosY;
      }

      elem.style.left = posX + "px";
      elem.style.top = posY + "px";
    }

    if (ev.isFinal) {
      isDragging = false;
      $elem = new Object();
    }
  };

  var openContent = function (id) {
    resetAudio();
    resetTool();
    $(".contents > div")
      .removeClass("showANS")
      .eq(id)
      .addClass("selected")
      .siblings(".selected")
      .removeClass("selected");
    resetElem($(".contents > div.selected"));
    //show side tool btn
    if ($(".contents > div.selected").find(".ans").length > 0) {
      $(".sideTool > div.eye").fadeIn();
    }
    if ($(".contents > div.selected").find("audio.a1").length > 0) {
      $(".sideTool > div.speaker.a1").fadeIn();
    }
    if ($(".contents > div.selected").find("audio.a2").length > 0) {
      $(".sideTool > div.speaker.a2").fadeIn();
    }
    if (
      $(".contents > div.selected").height() >
      $("#root").height() * 0.9 - 50
    ) {
      $(".sideTool > div.fit").fadeIn();
    }
    //bingo
    if (id == 2) {
      $(".contents > div.selected").find(".board").empty();
      var ref = $(".contents > div.selected").find(".sensor");
      var refArray = [];
      for (var k = 0; k < ref.length; k++) {
        refArray.push(k);
      }
      shuffle(refArray);
      $(".contents > div.selected")
        .find(".bingo_wrapper .start")
        .unbind()
        .bind("click", function () {
          var amount = $(".contents > div.selected")
            .find(".board")
            .find("p").length;
          if (amount == 0) {
            $(".contents > div.selected")
              .find(".bingo_wrapper .start")
              .text("Next");
            $(".contents > div.selected")
              .find(".bingo_wrapper .reset")
              .addClass("active");
          } else if (amount == 24) {
            $(".contents > div.selected")
              .find(".bingo_wrapper .start")
              .text("End");
          } else if (amount >= 25) {
            return false;
          }
          ref.eq(refArray[amount]).mousedown().mouseup();
          $(".contents > div.selected")
            .find(".board")
            .append(`<p>${refArray[amount] + 1}</p>`);
          $(".contents > div.selected")
            .find(".bingo_wrapper .bin")
            .text(refArray[amount] + 1);
        });
      $(".contents > div.selected")
        .find(".bingo_wrapper .reset")
        .unbind()
        .bind("click", function () {
          $(this).removeClass("active");
          $(".contents > div.selected").find(".board").empty();
          $(".contents > div.selected")
            .find(".bingo_wrapper .start")
            .text("Start");
          $(".contents > div.selected").find(".bingo_wrapper .bin").text("");
          shuffle(refArray);
        });
    }
  };

  var resetElem = function (elem) {
    var ft = ($("#root").height() - elem.height()) / 2 / stageRatio - 25;
    if (ft < 50) {
      ft = 50;
    }
    var styles = {
      transform: "none",
      top: ft,
      left: 200,
    };
    elem.css(styles);
  };

  var resetTool = function () {
    $(".sideTool > div").removeClass("active").hide();
    $(".WLS1-1-8-1 .ans1,.WLS1-1-8-1 .ans2").hide();
    $(".WLS1-1-8-1 .eye1,.WLS1-1-8-1 .eye2").removeClass("active");
  };
</script>
